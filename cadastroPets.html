<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Pets ‚Äî Patas Pousada</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

    :root{
      --brand:#e2725b; --brand-strong:#d45f47; --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --white:#fff;
      --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.06); --line:#e5e7eb;
      --chip:#fff0ec; --chip-border:#ffd8cf;
      --transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    body{font-family:'Nunito',sans-serif;line-height:1.5;background:var(--bg);color:var(--ink);margin:0; -webkit-font-smoothing: antialiased;}
    *{box-sizing: border-box;} /* Garante que padding n√£o quebre o layout */
    
    /* Header Consistente */
    header{display:flex;justify-content:center;background:rgba(255,255,255,0.95);box-shadow:0 1px 3px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px);}
    nav{max-width:1100px;width:100%;padding:12px 24px;display:flex;align-items:center;justify-content: space-between;}
    .logo{display:flex;align-items:center;gap:8px; color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800; font-size: 1.2rem; text-decoration: none;}
    .logo img{width:28px;height:28px;}
    nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0; align-items: center;}
    nav ul a{font-family:Parkinsans,sans-serif;font-weight:600;color:#4b5563; font-size: 0.9rem; text-decoration: none; transition: color var(--transition);}
    nav ul a:hover{color:var(--brand)}

    /* Layout Principal */
    .container{max-width:640px;margin:32px auto;padding:0 20px;}
    
    /* Barra de Topo (Bot√£o Voltar) */
    .top-bar { display: flex; margin-bottom: 10px; }
    .btn-back {
        display: inline-flex; align-items: center; gap: 8px;
        background: #fff; border: 1px solid var(--line);
        padding: 8px 16px; border-radius: 30px;
        color: var(--muted); font-weight: 700; font-size: 0.9rem;
        text-decoration: none; transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    }
    .btn-back:hover { border-color: var(--brand); color: var(--brand); background: #fff; transform: translateX(-2px); }

    h2{text-align:center;margin-bottom:24px;color:var(--brand);font-family:'Parkinsans',sans-serif; font-weight: 800; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; gap: 10px;}
    
    /* Pet Card Wrapper */
    .pet-card{
      position:relative;
      background:#fff;
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:28px; /* Aumentei um pouco para dar respiro */
      margin-bottom:24px;
      transition:transform 0.3s ease, opacity 0.3s ease;
      border: 1px solid transparent;
    }
    .pet-card:hover{ border-color: var(--chip-border); }
    .pet-card.fade-out{ opacity:0; transform:translateY(-10px); }

    .pet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px; padding-bottom: 12px; border-bottom: 1px solid var(--line);}
    .pet-header h4{font-family: 'Parkinsans', sans-serif; font-size: 1.2rem; color: var(--ink); margin: 0;}
    
    .remove-pet-btn{
      background:#fee2e2; color:#b91c1c; border:none; width: 32px; height: 32px; border-radius: 8px;
      cursor:pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .remove-pet-btn:hover{background:#ef4444; color: #fff;}

    /* Formul√°rios - Alinhamento Melhorado */
    label{
        display:block;
        margin: 0 0 6px 0; /* Reduzi a margem inferior para colar no input */
        font-weight:700; color: #374151; font-size: 0.9rem;
    }
    
    /* Wrapper para inputs para garantir espa√ßamento vertical consistente */
    .form-group { margin-bottom: 16px; width: 100%; }

    input[type="text"],input[type="number"],select,textarea{
      width:100%; padding:12px; margin:0; /* Remove margem padr√£o */
      border:1px solid #d1d5db;border-radius:10px;
      font-family: inherit; font-size: 0.95rem; outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #fff;
      height: 48px; /* Altura fixa para alinhar selects e inputs */
    }
    textarea { height: auto; min-height: 100px; resize: vertical; }

    input:focus, select:focus, textarea:focus{ border-color: var(--brand); box-shadow: 0 0 0 3px var(--chip); }

    /* Grid de Inputs (para layout lado a lado) */
    .input-row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px; /* Espa√ßo horizontal entre colunas */
        width: 100%;
    }
    @media (max-width: 500px) { .input-row { grid-template-columns: 1fr; gap: 0; } }

    /* Radio Group */
    .radio-group{
        display: flex; gap: 20px; background: #f9fafb; 
        padding: 0 14px; border-radius: 10px; border: 1px solid #e5e7eb;
        height: 48px; align-items: center; /* Alinha com os inputs de texto */
    }
    .radio-group label{margin:0; font-weight: 600; color: #4b5563; cursor: pointer; display: flex; align-items: center; gap: 8px;}
    input[type="radio"] { accent-color: var(--brand); transform: scale(1.1); cursor: pointer; height: auto; margin: 0;}

    /* Upload e Preview */
    .upload-area { margin-top: 10px; display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px; border: 2px dashed #e5e7eb; border-radius: 12px; background: #f9fafb; }
    .preview img{width:120px;height:120px;object-fit:cover;border-radius:50%;border:4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display:none}
    input[type="file"] { width: auto; border: none; background: transparent; font-size: 0.9rem; height: auto; }

    /* Bot√µes */
    .actions-area { display: flex; flex-direction: column; gap: 12px; margin-top: 30px; }
    
    .main-btn{
      width:100%; padding:14px; border-radius:30px; font-weight: 800; font-family: 'Parkinsans', sans-serif;
      cursor:pointer; font-size:1rem; transition:all 0.2s; border: 2px solid transparent; text-align: center;
    }
    
    #salvar { background:var(--brand); color:#fff; box-shadow: 0 4px 15px rgba(226, 114, 91, 0.4); }
    #salvar:hover { background:var(--brand-strong); transform: translateY(-2px); }
    #salvar:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

    .add-pet { background:#fff; color:var(--brand); border-color: var(--brand); }
    .add-pet:hover { background: var(--chip); }

    /* Toast */
    .alerta-sucesso{
      display:none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      background:#1f2937; color:#fff; padding:12px 24px; border-radius:30px;
      box-shadow:0 10px 30px rgba(0,0,0,0.2); font-weight:bold; font-size: 0.95rem; z-index: 200;
      opacity:0; transition:opacity 0.5s ease; width: auto; border: none;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html" class="logo">
        <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="Icone">
        Patas Pousada
      </a>
      <ul>
        <li><a href="home_tutor.html">In√≠cio</a></li>
        <li><a href="ajuda.html">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <div id="mensagem-sucesso" class="alerta-sucesso"></div>

  <div class="container">
    
    <div class="top-bar">
        <a href="meusPets.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Voltar</a>
    </div>

    <h2>Cadastro de Pets <i class="fa-solid fa-paw"></i></h2>

    <form id="formPets">
      <div id="form-container"></div>
      
      <div class="actions-area">
        <button type="button" class="main-btn add-pet" id="btnAdd"><i class="fa-solid fa-plus"></i> Adicionar outro pet</button>
        <button type="submit" class="main-btn" id="salvar"><i class="fa-solid fa-check"></i> Salvar Pets</button>
      </div>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    if (params.has("sucesso")) {
      const msg = decodeURIComponent(params.get("sucesso"));
      const div = document.getElementById("mensagem-sucesso");
      div.textContent = msg;
      div.style.display = "block";
      setTimeout(() => (div.style.opacity = "1"), 100);
      setTimeout(() => (div.style.opacity = "0"), 5000);
    }

    let contadorPets = 0;
    
    function adicionarPet(){
      contadorPets++;
      const container = document.getElementById("form-container");
      const petDiv = document.createElement("div");
      petDiv.classList.add("pet-card");
      petDiv.id = `pet_${contadorPets}`;

      const temBotaoRemover = contadorPets > 1
        ? `<button type="button" class="remove-pet-btn" onclick="removerPet(${contadorPets})" title="Remover este pet"><i class="fa-solid fa-trash"></i></button>`
        : "";

      // HTML Estruturado com Form Groups e Grid
      petDiv.innerHTML = `
        <div class="pet-header">
          <h4>üê∂ Dados do Pet ${contadorPets}</h4>
          ${temBotaoRemover}
        </div>

        <div class="form-group">
            <label>Nome do Pet:</label>
            <input type="text" name="nome_pet_${contadorPets}" required placeholder="Ex: Thor, Mel, Bob...">
        </div>

        <div class="input-row">
            <div class="form-group">
                <label>Esp√©cie:</label>
                <select name="especie_pet_${contadorPets}" required onchange="mostrarOutro(this, ${contadorPets})">
                  <option value="">Selecione</option>
                  <option value="Cachorro">Cachorro</option>
                  <option value="Gato">Gato</option>
                  <option value="P√°ssaro">P√°ssaro</option>
                  <option value="Roedor">Roedor</option>
                  <option value="R√©ptil">R√©ptil</option>
                  <option value="Outro">Outro</option>
                </select>
                <input type="text" id="outro_${contadorPets}" name="outro_especie_${contadorPets}" placeholder="Qual esp√©cie?" style="display:none; margin-top:10px;">
            </div>
            <div class="form-group">
                <label>Ra√ßa:</label>
                <input type="text" name="raca_pet_${contadorPets}" placeholder="Ex: Poodle, SRD...">
            </div>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label>Sexo:</label>
                <div class="radio-group">
                  <label><input type="radio" name="sexo_pet_${contadorPets}" value="Macho" required> Macho</label>
                  <label><input type="radio" name="sexo_pet_${contadorPets}" value="F√™mea"> F√™mea</label>
                </div>
            </div>
            <div class="form-group">
                <label>Idade (anos):</label>
                <input type="number" name="idade_pet_${contadorPets}" min="0" max="40" required placeholder="Ex: 3">
            </div>
        </div>

        <div class="form-group">
            <label>Porte:</label>
            <select name="porte_pet_${contadorPets}" required>
            <option value="">Selecione o porte</option>
            <option value="Pequeno">Pequeno (at√© 10kg)</option>
            <option value="M√©dio">M√©dio (10kg a 25kg)</option>
            <option value="Grande">Grande (mais de 25kg)</option>
            </select>
        </div>

        <div class="form-group">
            <label>Observa√ß√µes / Cuidados Especiais:</label>
            <textarea name="obs_pet_${contadorPets}" placeholder="Ex: Toma rem√©dio controlado, tem alergia a frango, √© muito soci√°vel..."></textarea>
        </div>

        <div class="upload-area">
            <label style="margin:0; color:var(--brand);">Foto do Pet (Opcional)</label>
            <div class="preview"><img id="preview_${contadorPets}" alt="Preview do pet"></div>
            <input type="file" name="foto_pet_${contadorPets}" accept="image/*" onchange="previewImagem(event, ${contadorPets})">
        </div>
      `;
      container.appendChild(petDiv);
    }

    function mostrarOutro(select, id){
      const outro = document.getElementById(`outro_${id}`);
      outro.style.display = select.value === "Outro" ? "block" : "none";
      if(select.value === "Outro") outro.focus();
    }

    function previewImagem(event, id){
      const preview = document.getElementById(`preview_${id}`);
      const arquivo = event.target.files[0];
      if(arquivo){
        const leitor = new FileReader();
        leitor.onload = () => { preview.src = leitor.result; preview.style.display = "block"; };
        leitor.readAsDataURL(arquivo);
      }else{
        preview.style.display = "none";
      }
    }

    function removerPet(id){
      const petCard = document.getElementById(`pet_${id}`);
      petCard.classList.add("fade-out");
      setTimeout(() => petCard.remove(), 300);
    }

    document.addEventListener("submit", (e) => {
      if(e.target.id === "formPets"){
        const cards = document.querySelectorAll(".pet-card");
        if (cards.length === 0){ e.preventDefault(); alert("Adicione pelo menos 1 pet."); }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    // ====== CONFIG (L√≥gica Original Mantida) ======
    const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
    const BUCKET = "pet-photos";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function requireAuth(){
      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        window.location.href = "cadastrarouentrar.html?next=cadastroPets.html";
        return null;
      }
      return user;
    }

    async function uploadFoto(userId, idx, file){
      if(!file) return null;
      const ext ¬†= (file.name.split(".").pop() || "jpg").toLowerCase();
      const path = `${userId}/${Date.now()}_pet${idx}.${ext}`;
      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, file, { upsert:false });
      if(upErr) throw upErr;
      const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
      return pub?.publicUrl || null;
    }

    function lerPetDoCard(card, idx){
      const nome ¬† = card.querySelector(`[name="nome_pet_${idx}"]`)?.value?.trim();
      const especieSel = card.querySelector(`[name="especie_pet_${idx}"]`)?.value;
      const especieOut = card.querySelector(`[name="outro_especie_${idx}"]`)?.value?.trim();
      const raca ¬† = card.querySelector(`[name="raca_pet_${idx}"]`)?.value?.trim() || null;
      const sexo ¬† = card.querySelector(`[name="sexo_pet_${idx}"]:checked`)?.value || null;
      const idade ¬†= card.querySelector(`[name="idade_pet_${idx}"]`)?.value || null;
      const porte ¬†= card.querySelector(`[name="porte_pet_${idx}"]`)?.value || null;
      const obs ¬† ¬†= card.querySelector(`[name="obs_pet_${idx}"]`)?.value?.trim() || null;
      const file ¬† = card.querySelector(`[name="foto_pet_${idx}"]`)?.files?.[0] || null;
      const especie = (especieSel === "Outro" && especieOut) ? especieOut : especieSel;
      return { nome, especie, raca, sexo, idade: idade?Number(idade):null, porte, obs, file };
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      const user = await requireAuth();
      if(!user) return;

      adicionarPet();
      document.getElementById("btnAdd").addEventListener("click", adicionarPet);

      document.getElementById("formPets").addEventListener("submit", async (e)=>{
        e.preventDefault();

        const cards = Array.from(document.querySelectorAll(".pet-card"));
        if(cards.length === 0){ alert("Adicione pelo menos 1 pet."); return; }

        const btn = document.getElementById("salvar");
        btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';

        try{
          let total = 0;
          for(let i=0;i<cards.length;i++){
            const idx = i+1; 
            const realId = cards[i].id.split('_')[1]; 
            const pet = lerPetDoCard(cards[i], realId);

            if(!pet.nome || !pet.especie || !pet.sexo || !pet.idade || !pet.porte){
              throw new Error(`Preencha todos os campos obrigat√≥rios do Pet.`);
            }

            const photo_url = await uploadFoto(user.id, realId, pet.file);

            const payload = {
              owner_id: user.id,
              name: pet.nome,
              species: pet.especie,
              breed: pet.raca,
              sex: pet.sexo,
              size: pet.porte,
              special_needs: pet.obs,
              photo_url,
              birthdate: null,
              weight_kg: null,
              vaccinated: false,
              neutered: false,
              temperament: null
            };

            const { error: insErr } = await sb.from("pets").insert(payload);
            if(insErr) throw insErr;
            total++;
          }

          const msg = encodeURIComponent("Pets cadastrados com sucesso!");
          window.location.href = `meusPets.html?sucesso=${msg}`;

        }catch(err){
          console.error(err);
          alert("Falha ao salvar pets: " + (err?.message || err));
          btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-check"></i> Salvar Pets';
        }
      });
    });
  </script>
</body>
</html>