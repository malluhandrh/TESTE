<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu de Perfil • Patas Pousada</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

    :root{
      --brand:#e2725b; --brand-strong:#d45f47; --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --white:#fff;
      --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.06); --line:#e5e7eb;
      --chip:#fff0ec; --chip-border:#ffd8cf;
      --transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Nunito,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink); -webkit-font-smoothing: antialiased; line-height: 1.5;}
    a { text-decoration: none; color: inherit; }

    /* HEADER - AUMENTADO O PADDING */
    header{display:flex;justify-content:center;background:rgba(255,255,255,0.95);box-shadow:0 1px 3px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px);}
    .nav{max-width:1100px;width:100%;padding:16px 24px;display:flex;align-items:center;justify-content: space-between;}
    
    /* LOGO MAIOR */
    .logo{display:flex;align-items:center;gap:10px; color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800; font-size: 1.35rem;}
    .logo img{width:34px;height:34px;}
    
    /* LINKS MAIORES */
    .nav ul{list-style:none;display:flex;gap:24px;margin:0;padding:0; align-items: center;}
    .nav a.link{font-family:Parkinsans,sans-serif;font-weight:600;color:#4b5563; font-size: 1rem; transition: color var(--transition);}
    .nav a.link:hover{color:var(--brand)}

    /* USER MENU */
    .user{position:relative; display:flex; align-items:center;}
    
    /* TRIGGER MAIOR */
    .user__trigger{display:flex;align-items:center;gap:10px;cursor:pointer; padding: 6px 12px 6px 6px; border-radius: 40px; transition: background var(--transition); border: 1px solid transparent;}
    .user__trigger:hover { background: #fff; border-color: var(--line); box-shadow: var(--shadow); }
    
    /* Estilo da Badge (Inicial) - AUMENTADO PARA 40px */
    .badge{
      width:40px;height:40px;border-radius:50%;
      background:var(--chip);display:grid;place-items:center;
      color:var(--brand);font-weight:800;font-size:1.1rem;
      border: 1px solid var(--chip-border);
    }
    
    /* Estilo da Imagem do Avatar (Novo) - AUMENTADO PARA 40px */
    .user__avatar-img {
        width: 40px; height: 40px; border-radius: 50%;
        object-fit: cover; display: none; /* Oculto por padrão */
        border: 1px solid var(--line); background: #eee;
    }

    /* NOME MAIOR */
    .user__trigger span{
      max-width:140px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-weight:700; font-size: 1rem; color: var(--ink);
    }
    .user__trigger svg { width: 12px; fill: #9ca3af; transition: transform 0.2s; }
    .user:hover .user__trigger svg { transform: rotate(180deg); }

    .user__dropdown{
      position:absolute; top:calc(100% + 8px); right:0;
      background:#fff; border-radius:12px; border:1px solid var(--line);
      box-shadow:0 10px 25px rgba(0,0,0,0.1);
      width:220px; opacity:0; visibility:hidden; transform:translateY(10px);
      transition:all 0.2s; z-index:30; padding: 6px; overflow: hidden;
    }
    .user:hover .user__dropdown{ opacity:1; visibility:visible; transform:translateY(0); }

    .user__item{
      display:flex; gap:10px; align-items:center;
      padding:10px 14px; border-radius:8px;
      color:#4b5563; font-weight:600; font-size: 0.85rem;
      transition: background var(--transition);
    }
    .user__item:hover{ background:#f9fafb; color: var(--brand); }
    .user__item i { width: 16px; text-align: center; }
    .dropdown-sep{ height:1px; background:var(--line); margin:4px 0; }
    .pp-danger{ color:#dc2626; }
    .pp-danger:hover { background: #fee2e2; color: #b91c1c; }

    /* CONTEÚDO */
    .wrap{max-width:800px;margin:40px auto;padding:0 24px; min-height: 60vh;}

    /* BOTÃO VOLTAR */
    .back-btn{
      display:inline-flex; align-items:center; gap:8px;
      margin-bottom:24px; padding:8px 16px;
      border-radius:30px; border:1px solid var(--line);
      background:#fff; color:var(--muted);
      font-weight:700; font-size:.85rem;
      cursor:pointer; text-decoration:none;
      box-shadow:0 2px 5px rgba(0,0,0,.03);
      transition: all 0.2s;
    }
    .back-btn:hover{
      background:#fff; border-color:var(--brand); color:var(--brand);
      transform:translateX(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .title{font:800 1.8rem Parkinsans,sans-serif;color:var(--ink);text-align:center;margin-bottom:8px}
    .lead{color:var(--muted);text-align:center;margin-bottom:40px; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 0.95rem;}

    /* GRID DE CARDS */
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr 1fr; } }

    .card{
      background:#fff;border:1px solid transparent;border-radius:16px;
      box-shadow:var(--shadow);
      padding:24px; display:flex; flex-direction: column; gap:16px; align-items:center; text-align: center;
      text-decoration:none; color:var(--ink);
      transition:transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.08); border-color: var(--chip-border);}
    
    .icon-box {
        width: 56px; height: 56px; background: var(--chip); color: var(--brand);
        border-radius: 50%; display: grid; place-items: center; font-size: 1.4rem;
        margin-bottom: 4px; transition: transform 0.3s;
    }
    .card:hover .icon-box { transform: scale(1.1); background: #ffe4de; }

    .card-content h3{font:700 1.1rem Parkinsans,sans-serif;margin-bottom:6px; color: var(--ink);}
    .card-content p{color:var(--muted);font-size:0.85rem; line-height: 1.4;}
    
    .carret{
        margin-top: auto; font-size: 0.8rem; color: var(--brand); font-weight: 700; 
        opacity: 0; transform: translateY(5px); transition: all 0.2s;
    }
    .card:hover .carret { opacity: 1; transform: translateY(0); }

    /* MODAL EXCLUIR CONTA */
    .pp-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60; backdrop-filter: blur(4px);}
    .pp-card{width:min(460px,92vw);background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.3);overflow:hidden;transform:translateY(20px);opacity:0;transition:all 0.2s;}
    .pp-card.show{transform:translateY(0);opacity:1;}
    
    .pp-card header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid #fee2e2;background:#fff5f5;}
    .pp-card header .ic{width:24px;height:24px;display:grid;place-items:center;border-radius:50%;background:#fee2e2;color:#b91c1c;font-weight:900; font-size: 0.9rem;}
    .pp-card h4{margin:0;font-weight:700;color:#991b1b; font-size: 1.1rem;}
    
    .pp-body{padding:24px; font-size: 0.95rem; color: #374151;}
    .pp-body p{margin-bottom:12px; line-height: 1.5;}
    
    .pp-body input{
        width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;
        margin:4px 0 16px; font-family: inherit; outline: none; transition: border-color 0.2s;
    }
    .pp-body input:focus { border-color: var(--brand); box-shadow: 0 0 0 3px var(--chip); }

    .pp-ft{display:flex;gap:12px;justify-content:flex-end;padding:16px 20px;background:#f9fafb;border-top:1px solid #f3f4f6;}
    .pp-btn{border-radius:8px;padding:10px 16px;font-weight:700;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-size:0.9rem; transition: all 0.2s;}
    .pp-btn:hover { background: #f3f4f6; }
    .pp-ok{background:#dc2626;color:#fff;border-color:#dc2626;}
    .pp-ok:hover{background:#b91c1c;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:12px 24px;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-size:.9rem;display:none;z-index:70; font-weight: 600;}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <nav class="nav">
    <a class="logo" href="index.html">
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="">
      Patas Pousada
    </a>
    <ul>
      <li><a class="link" href="reservas.html">Reservas</a></li>
      <li><a class="link" href="ajuda.html">Ajuda</a></li>
      <li><a class="link" href="Lartemp.html" style="color:var(--brand)">Lar Temporário</a></li>
    </ul>
    <div class="user" id="userMenuRoot">
      <div class="user__trigger">
        <img id="userAvatar" class="user__avatar-img" src="" alt="Foto">
        
        <div class="badge" id="userInitial">U</div>
        
        <span id="userName">Usuário</span>
        <svg width="10" height="10" viewBox="0 0 24 24"><path fill="#6b7280" d="M7 10l5 5 5-5z"/></svg>
      </div>
      <div class="user__dropdown">
        <a class="user__item" href="menu_perfil.html"><i class="fa-solid fa-user-pen"></i> Editar perfil</a>
        <a class="user__item" href="meusPets.html"><i class="fa-solid fa-paw"></i> Meus pets</a>
        <a class="user__item" href="#" id="btnLogout"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</a>
        <div class="dropdown-sep"></div>
        <a class="user__item pp-danger" href="#" id="deleteAccountLink">
          <i class="fa-solid fa-user-xmark"></i> Excluir conta
        </a>
      </div>
    </div>
  </nav>
</header>

<main class="wrap">
  <button type="button" class="back-btn" onclick="window.location.href='home_tutor.html'">
    <i class="fa-solid fa-arrow-left"></i>
    <span>Voltar para área do tutor</span>
  </button>

  <h1 class="title">Gerenciar Perfil</h1>
  <p class="lead">Atualize seus dados pessoais, gerencie seus pets e configure a segurança da sua conta.</p>

  <div class="grid">
    <a class="card" href="editarperfil.html">
      <div class="icon-box"><i class="fa-solid fa-user-gear"></i></div>
      <div class="card-content">
        <h3>Dados Pessoais</h3>
        <p>Nome, endereço, contatos e informações básicas.</p>
      </div>
      <div class="carret">Acessar <i class="fa-solid fa-arrow-right"></i></div>
    </a>

    <a class="card" href="meusPets.html">
      <div class="icon-box"><i class="fa-solid fa-paw"></i></div>
      <div class="card-content">
        <h3>Meus Pets</h3>
        <p>Adicione ou edite o perfil dos seus bichinhos.</p>
      </div>
      <div class="carret">Acessar <i class="fa-solid fa-arrow-right"></i></div>
    </a>

    <a class="card" href="alterar-senha.html">
      <div class="icon-box"><i class="fa-solid fa-shield-halved"></i></div>
      <div class="card-content">
        <h3>Segurança</h3>
        <p>Altere sua senha e configurações de acesso.</p>
      </div>
      <div class="carret">Acessar <i class="fa-solid fa-arrow-right"></i></div>
    </a>
  </div>
</main>

<div class="pp-wrap" id="ppDelete" style="display:none">
  <div class="pp-card" role="dialog" aria-modal="true">
    <header>
      <span class="ic"><i class="fa-solid fa-exclamation"></i></span>
      <h4>Excluir sua conta</h4>
    </header>
    <div class="pp-body">
      <p>Esta ação é <strong>irreversível</strong>. Todos os seus dados (perfil, pets, reservas, arquivos) serão removidos permanentemente.</p>
      <p style="margin-top:10px; font-size: 0.85rem; font-weight: 700; color: #111;">Para confirmar, digite <span style="color:#dc2626">EXCLUIR</span>:</p>
      <input id="delConfirmText" type="text" placeholder="EXCLUIR">
      
      <p style="margin-top:10px; font-size: 0.85rem; font-weight: 700; color: #111;">Informe sua senha atual:</p>
      <input id="delPassword" type="password" placeholder="Senha atual">
    </div>
    <div class="pp-ft">
      <button class="pp-btn" id="delCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="delOk">Sim, excluir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userNameEl    = document.getElementById('userName');
  const userInitialEl = document.getElementById('userInitial');
  const userAvatarEl  = document.getElementById('userAvatar'); // Elemento novo
  const btnLogout     = document.getElementById('btnLogout');
  const deleteAccountLink = document.getElementById('deleteAccountLink');

  function toast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg; t.style.display='block';
    setTimeout(()=>t.style.display='none',2200);
  }

  function initialsFromName(name){
    if(!name) return 'U';
    const parts = name.trim().split(/\s+/);
    const p1 = parts[0]?.[0] || '';
    const p2 = parts[1]?.[0] || '';
    const ini = (p1 + p2).toUpperCase();
    return ini || 'U';
  }

  async function initUser(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){
      location.href = "cadastrarouentrar.html?next=menu_perfil.html";
      return null;
    }

    const emailPrefix = user.email.split('@')[0];
    let display = emailPrefix;
    let avatarUrl = null;

    try{
      // ATUALIZADO: adicionado select('..., avatar_url')
      const { data } = await sb
        .from('profiles')
        .select('first_name,last_name,full_name,avatar_url') 
        .eq('id', user.id)
        .maybeSingle();

      if (data) {
        if (data.first_name || data.last_name) {
          const composed = `${data.first_name || ''} ${data.last_name || ''}`.trim();
          if (composed) display = composed;
        } else if (data.full_name && data.full_name.trim() !== '') {
          display = data.full_name;
        }
        // Pega a URL do avatar
        avatarUrl = data.avatar_url;
      }
    }catch(e){
      console.error('Erro buscando profile:', e);
    }

    // fallback: metadata
    if((display === emailPrefix || !display) && user.user_metadata?.full_name){
      display = user.user_metadata.full_name;
    }

    userNameEl.textContent = display || emailPrefix;

    // LÓGICA DO AVATAR COM CACHE BUSTER
    if (avatarUrl) {
        // Mostra imagem, esconde badge
        userInitialEl.style.display = 'none';
        userAvatarEl.style.display = 'block';
        
        // Adiciona timestamp para forçar atualização
        const urlComCache = avatarUrl + '?t=' + new Date().getTime();
        userAvatarEl.src = urlComCache;
    } else {
        // Mostra badge, esconde imagem
        userAvatarEl.style.display = 'none';
        userInitialEl.style.display = 'grid';
        userInitialEl.textContent = initialsFromName(display || emailPrefix);
    }

    return user;
  }

  btnLogout.addEventListener('click', async (e)=>{
    e.preventDefault();
    await sb.auth.signOut();
    location.href = "index.html";
  });

  // ===== Modal excluir conta (UI) =====
  const ppDelete       = document.getElementById('ppDelete');
  const delCancel      = document.getElementById('delCancel');
  const delOk          = document.getElementById('delOk');
  const delConfirmText = document.getElementById('delConfirmText');
  const delPassword    = document.getElementById('delPassword');

  function openDeleteModal(){
    ppDelete.style.display='flex';
    requestAnimationFrame(()=>ppDelete.querySelector('.pp-card').classList.add('show'));
    setTimeout(()=>delConfirmText?.focus(), 80);
  }
  function closeDeleteModal(){
    const card = ppDelete.querySelector('.pp-card');
    card.classList.remove('show');
    setTimeout(()=>{ ppDelete.style.display='none'; }, 200);
    delConfirmText.value=''; delPassword.value='';
  }

  deleteAccountLink?.addEventListener('click', (e)=>{
    e.preventDefault();
    openDeleteModal();
  });
  delCancel?.addEventListener('click', closeDeleteModal);
  ppDelete?.addEventListener('click', e=>{ if(e.target.id==='ppDelete') closeDeleteModal(); });

  delOk?.addEventListener('click', ()=>{
    const okWord = delConfirmText.value.trim().toUpperCase() === 'EXCLUIR';
    if(!okWord){ toast('Digite EXCLUIR para confirmar.'); delConfirmText.focus(); return; }
    if(!delPassword.value.trim()){ toast('Informe sua senha atual.'); delPassword.focus(); return; }
    toast('Confirmação recebida. (Implementar exclusão real depois)');
    closeDeleteModal();
  });

  // boot
  (async ()=>{
    await initUser();
  })();
</script>
</body>
</html>