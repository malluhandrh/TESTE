<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Meus Pets ‚Äî Patas Pousada</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

  :root{
    --brand:#e2725b; --brand-strong:#d45f47; --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --white:#fff;
    --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.06); --line:#e5e7eb;
    --chip:#fff0ec; --chip-border:#ffd8cf;
    --transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Nunito,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink); line-height: 1.5; -webkit-font-smoothing: antialiased;}
  a{color:inherit;text-decoration:none; transition: color var(--transition);}

  /* HEADER (Igual √† Home) */
  header{display:flex;justify-content:center;background:rgba(255,255,255,0.95);box-shadow:0 1px 3px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px);}
  nav{max-width:1100px;width:100%;padding:12px 24px;display:flex;align-items:center;justify-content: space-between;}
  .logo{display:flex;align-items:center;gap:8px; color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800; font-size: 1.2rem;}
  .logo img{width:28px;height:28px;}
  
  nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0; align-items: center;}
  nav ul a{font-family:Parkinsans,sans-serif;font-weight:600;color:#4b5563; font-size: 0.9rem;}
  nav ul a:hover{color:var(--brand)}
  .pill{color:var(--brand); background: var(--chip); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem;}
  .pill:hover{background: #ffe4de;}

  /* User menu */
  .user-menu{position:relative; display: none;}
  .user-trigger{display:flex;align-items:center;gap:8px;cursor:pointer; padding: 4px 8px 4px 4px; border-radius: 30px; transition: background var(--transition); border: 1px solid transparent;}
  .user-trigger:hover { background: #fff; border-color: var(--line); box-shadow: var(--shadow); }
  .user-trigger img{width:32px;height:32px;border-radius:50%;border:1px solid #fff;background:#eee;object-fit:cover;}
  .user-trigger strong { font-size: 0.85rem; color: #374151; }
  .user-trigger svg{width:10px;height:10px;fill:#9ca3af;transition:transform .2s}
  .user-menu:hover .user-trigger svg{transform:rotate(180deg)}
  
  .dropdown{position:absolute;top:calc(100% + 8px);right:0;background:#fff;border-radius:12px;box-shadow: 0 10px 25px rgba(0,0,0,0.1); width:220px;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s;z-index:30; overflow: hidden; border: 1px solid var(--line);}
  .user-menu:hover .dropdown{opacity:1;visibility:visible;transform:translateY(0)}
  .dropdown a{display:flex;align-items: center; gap:10px;padding:10px 16px;color:#4b5563;font-weight:600; font-size: 0.85rem; transition: background var(--transition);}
  .dropdown a:hover{background:#f9fafb; color: var(--brand);}
  .dropdown i { width: 16px; text-align: center; }

  /* P√°gina */
  .wrap{max-width:1000px;margin:32px auto;padding:0 24px; min-height: 60vh;}
  
  .actions-top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:32px; align-items: center;}
  .actions-top h2{font:800 1.8rem Parkinsans,sans-serif;color:var(--ink); margin: 0; display: flex; align-items: center; gap: 10px;}
  .actions-top h2 i { color: var(--brand); font-size: 1.5rem; }

  .btn-pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);color:#4b5563;background:#fff;padding:10px 20px;border-radius:30px;font-weight:700;text-decoration:none;font-size:0.9rem; transition: all 0.2s; cursor: pointer;}
  .btn-pill:hover{background:#f9fafb; border-color: #d1d5db; color: var(--ink);}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff; box-shadow: 0 4px 10px rgba(226, 114, 91, 0.3);}
  .btn-primary:hover{background:var(--brand-strong); color: #fff; transform: translateY(-1px);}

  /* GRID E CARDS COMPACTOS */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
  }
  
  .card {
    background: #fff; border: 1px solid transparent; border-radius: 16px; 
    box-shadow: var(--shadow); overflow: hidden;
    display: flex;
    align-items: center;
    padding: 16px;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
  }
  .card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,.08); border-color: var(--chip-border); }

  .photo {
    width: 72px; height: 72px; 
    border-radius: 16px; 
    background: #f9fafb; border: 1px solid #eee;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; flex-shrink: 0;
    margin-right: 16px;
  }
  .photo img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
  .card:hover .photo img { transform: scale(1.1); }
  .photo-placeholder { font-size: 1.8rem; color: #d1d5db; }

  .body {
    flex: 1; text-align: left; padding: 0;
    display: flex; flex-direction: column; justify-content: center;
  }
  .body h3 {
    margin: 0 0 4px; color: var(--ink); 
    font: 800 1.1rem Parkinsans,sans-serif;
  }
  .body p {
    margin: 0; color: #6b7280; font-size: 0.9rem; 
    line-height: 1.4;
  }
  .details-row { display: flex; gap: 8px; font-size: 0.8rem; color: #9ca3af; margin-top: 4px; font-weight: 600;}
  
  .card-cta {
    display: flex; gap: 8px; padding: 0; margin-left: 12px; flex-direction: column;
  }
  .btn-icon {
    all: unset; display: flex; align-items: center; justify-content: center;
    width: 36px; height: 36px; border-radius: 10px; cursor: pointer;
    background: #f9fafb; color: #6b7280; transition: 0.2s;
  }
  .btn-icon:hover { background: #fff; color: var(--brand); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .btn-delete:hover { background: #fee2e2; color: #dc2626; }

  .empty{padding:40px; border-radius:16px; color:#6b7280; background:#fff; text-align:center; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; gap: 10px;}

  /* Modal edi√ß√£o */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:50; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.2s;}
  .modal.show{display:grid; opacity: 1;}
  .box{background:#fff;border-radius:20px;max-width:600px;width:92%;box-shadow:0 20px 50px rgba(0,0,0,0.2);overflow:hidden; transform: translateY(20px); transition: transform 0.2s;}
  .modal.show .box { transform: translateY(0); }

  .box-hd{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--line); background: #fff;}
  .box-hd h3{margin:0;font:700 1.2rem Parkinsans,sans-serif; color: var(--ink);}
  .box-bd{padding:24px;max-height:70vh;overflow-y:auto;}
  
  /* Form Styles */
  .box-bd label{display:block;margin:12px 0 6px;font-weight:700; font-size: 0.9rem; color: #374151;}
  .box-bd input, .box-bd select, .box-bd textarea{
    width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:8px; 
    font-family: inherit; font-size: 0.95rem; color: #1f2937; outline: none; transition: border-color 0.2s;
  }
  .box-bd input:focus, .box-bd select:focus, .box-bd textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 3px var(--chip); }
  
  .box-ft{display:flex;justify-content:flex-end;gap:12px;padding:16px 24px;border-top:1px solid var(--line);background:#f9fafb}
  .x{cursor:pointer;border:none;background:transparent;font-size:22px; color: #9ca3af; transition: color 0.2s;}
  .x:hover { color: var(--ink); }

  /* Pretty Confirm */
  .pp-wrap{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60; backdrop-filter: blur(4px);}
  .pp-card{width:min(420px,92vw);background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.3);overflow:hidden;transform:scale(0.95);opacity:0;transition:all 0.2s;}
  .pp-card.show{transform:scale(1);opacity:1;}
  .pp-card header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid #fee2e2;background:#fff5f5;}
  .pp-card header .ic{width:24px;height:24px;display:grid;place-items:center;border-radius:50%;background:#fee2e2;color:#b91c1c;font-weight:900; font-size: 0.9rem;}
  .pp-card h4{margin:0;font-weight:700;color:#991b1b; font-size: 1.1rem;}
  .pp-body{padding:20px;font-size:.95rem;color:#374151;}
  .pp-body p { margin-top: 0; margin-bottom: 10px; }
  .pp-ft{display:flex;gap:12px;justify-content:flex-end;padding:16px 20px;background:#f9fafb;border-top:1px solid #f3f4f6;}
  .pp-btn{border-radius:8px;padding:10px 16px;font-weight:700;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-size:.9rem; transition: all 0.2s;}
  .pp-btn:hover{background:#f3f4f6;}
  .pp-ok{background:#dc2626;color:#fff;border-color:#dc2626;}
  .pp-ok:hover{background:#b91c1c;}

  /* Toast */
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:12px 24px;border-radius:30px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-size:.9rem;display:none;z-index:70; font-weight: 600;}

  /* Footer (Consist√™ncia) */
  footer{background:#fff;border-top:1px solid var(--line);padding:24px 0;text-align:center;margin-top:40px;}
  footer p{margin:0;color:var(--muted);font-size:0.85rem;}

  /* Mobile */
  @media (max-width: 600px) {
    .actions-top { flex-direction: column; align-items: flex-start; gap: 16px; }
    .actions-top div { width: 100%; display: flex; gap: 10px; }
    .btn-pill { flex: 1; justify-content: center; }
    .card { padding: 12px; }
    .photo { width: 60px; height: 60px; margin-right: 12px; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <nav>
    <a href="index.html" class="logo">
      <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="">
      <span>Patas Pousada</span>
    </a>

    <ul>
      <li><a href="reservas.html">Reservas</a></li>
      <li><a href="ajuda.html">Ajuda</a></li>
      <li><a class="pill" href="#">Lar Tempor√°rio</a></li>

      <li class="user-menu" id="userMenuRoot" style="display:none">
        <div class="user-trigger">
          <img id="userAvatar" alt="avatar">
          <strong id="userName">Usu√°rio</strong>
          <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5H7z"></path></svg>
        </div>
        <div class="dropdown">
          <a href="menu_perfil.html"><i class="fa-solid fa-user-pen"></i> Editar perfil</a>
          <a href="meusPets.html"><i class="fa-solid fa-paw"></i> Meus pets</a>
          <a href="#" id="logoutLink"><i class="fa-solid fa-arrow-right-from-bracket"></i> Sair</a>
          <div style="height:1px;background:#f3f4f6;margin:4px 0"></div>
          <a href="#" id="deleteAccountLink" style="color:#dc2626;font-weight:700;">
            <i class="fa-solid fa-user-xmark"></i> Excluir conta
          </a>
        </div>
      </li>
    </ul>
  </nav>
</header>

<div class="wrap">
  <div class="actions-top">
    <h2><i class="fa-solid fa-paw"></i> Meus Pets</h2>
    <div>
       <a class="btn-pill" href="home_tutor.html"><i class="fa-solid fa-arrow-left"></i> Voltar</a>
       <a class="btn-pill btn-primary" href="cadastroPets.html"><i class="fa-solid fa-plus"></i> Novo Pet</a>
    </div>
  </div>

  <div id="petsWrap">
    <div class="empty">
        <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: var(--brand); margin-bottom: 10px;"></i> 
        Carregando...
    </div>
  </div>
</div>

<div id="editModal" class="modal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="box-hd">
      <h3>Editar Pet</h3>
      <button class="x" id="closeEdit"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="box-bd">
      <form id="editForm">
        <input type="hidden" id="edit_id">
        <label>Nome</label>
        <input type="text" id="edit_name" required>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div><label>Esp√©cie</label><input type="text" id="edit_species" required></div>
            <div><label>Ra√ßa</label><input type="text" id="edit_breed"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div>
                <label>Sexo</label>
                <select id="edit_sex"><option value="Macho">Macho</option><option value="F√™mea">F√™mea</option></select>
            </div>
            <div>
                <label>Porte</label>
                <select id="edit_size"><option value="Pequeno">Pequeno</option><option value="M√©dio">M√©dio</option><option value="Grande">Grande</option></select>
            </div>
        </div>
        <label>Observa√ß√µes</label>
        <textarea id="edit_notes" rows="3"></textarea>

        <label>Foto atual</label>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:8px;">
          <div class="photo" style="margin:0;">
            <img id="edit_photo_preview" alt="Foto do pet" style="width:100%;height:100%;object-fit:cover;display:none;">
            <i id="edit_photo_placeholder" class="fa-solid fa-paw photo-placeholder"></i>
          </div>
        </div>

        <label>Foto (URL)</label>
        <input type="url" id="edit_photo_url" placeholder="https://...">

        <label>Nova foto (opcional)</label>
        <input type="file" id="edit_photo_file" accept="image/*" style="padding: 6px;">
      </form>
    </div>
    <div class="box-ft">
      <button class="btn-pill" id="cancelEdit">Cancelar</button>
      <button class="btn-pill btn-primary" id="saveEdit">Salvar Altera√ß√µes</button>
    </div>
  </div>
</div>

<div class="pp-wrap" id="ppConfirm" aria-hidden="true">
  <div class="pp-card">
    <header><span class="ic"><i class="fa-solid fa-exclamation"></i></span><h4>A√ß√£o irrevers√≠vel</h4></header>
    <div class="pp-body"><p id="ppMsg">Tem certeza?</p></div>
    <div class="pp-ft">
      <button class="pp-btn" id="ppCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="ppOk">Sim, excluir</button>
    </div>
  </div>
</div>

<div class="pp-wrap" id="ppDelete" style="display:none">
  <div class="pp-card">
    <header><span class="ic"><i class="fa-solid fa-exclamation"></i></span><h4>Excluir sua conta</h4></header>
    <div class="pp-body">
      <p>Esta a√ß√£o √© <strong>irrevers√≠vel</strong>. Todos os seus dados ser√£o removidos.</p>
      <p>Para confirmar, digite <strong>EXCLUIR</strong>:</p>
      <input id="delConfirmText" type="text" placeholder="EXCLUIR" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin:10px 0 0">
    </div>
    <div class="pp-ft">
      <button class="pp-btn" id="delCancel">Cancelar</button>
      <button class="pp-btn pp-ok" id="delOk">Sim, excluir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<footer>
  <div class="wrap" style="min-height:auto; margin: 0 auto;">
    <p>&copy; 2023 Patas Pousada. Todos os direitos reservados.</p>
  </div>
</footer>

<script>
  const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const petsWrap = document.getElementById('petsWrap');
  const userMenuRoot = document.getElementById('userMenuRoot');
  const userName = document.getElementById('userName');
  const userAvatar = document.getElementById('userAvatar');
  const logoutLink = document.getElementById('logoutLink');
  const deleteAccountLink = document.getElementById('deleteAccountLink');

  const editModal = document.getElementById('editModal');
  const editForm = document.getElementById('editForm');
  const editPhotoPreview = document.getElementById('edit_photo_preview');
  const editPhotoPlaceholder = document.getElementById('edit_photo_placeholder');
  const editPhotoFile = document.getElementById('edit_photo_file');
  const editPhotoUrlInput = document.getElementById('edit_photo_url');

  let currentUser = null;
  let newUploadedPhotoUrl = null; // guarda URL da nova foto (upload) durante a edi√ß√£o

  function toast(text){
      const t=document.getElementById('toast');
      t.textContent=text; t.style.display='block';
      setTimeout(()=>t.style.display='none', 2500);
  }

  function initialsFromName(name){
    if(!name) return 'üôÇ';
    const parts = name.trim().split(/\s+/);
    const p1 = parts[0]?.[0] || '';
    const p2 = parts[1]?.[0] || '';
    return (p1 + p2).toUpperCase() || 'üôÇ';
  }

  // ========= upload foto pet =========
  async function uploadPetPhoto(file, ownerId, petId){
    const ext = file.name.split('.').pop();
    const path = `pets/${ownerId}/pet_${petId || ('temp_' + Date.now())}.${ext}`;

    // usa o bucket "pet-photos"
    const { error } = await sb
      .storage
      .from('pet-photos')
      .upload(path, file, {
        upsert: true,
        contentType: file.type
      });

    if(error) throw error;

    const { data:pub } = sb.storage.from('pet-photos').getPublicUrl(path);
    return pub.publicUrl;
  }

  // ========== 1. Auth + HEADER ==========
  async function initUser(){
    const { data:{ user } } = await sb.auth.getUser();
    if(!user){
      location.href = "cadastrarouentrar.html?next=meusPets.html";
      return null;
    }

    currentUser = user;

    const emailPrefix = user.email.split('@')[0];
    let display = emailPrefix;
    let avatarUrl = null;

    try {
      const { data } = await sb
        .from('profiles')
        .select('full_name, avatar_url')
        .eq('id', user.id)
        .maybeSingle();

      if (data) {
        if (data.full_name && data.full_name.trim() !== '') {
          display = data.full_name;
        }
        if (data.avatar_url) {
          avatarUrl = data.avatar_url;
        }
      }
    } catch (e) {
      console.error('Erro buscando profile:', e);
    }

    if ((display === emailPrefix || !display) && user.user_metadata?.full_name) {
      display = user.user_metadata.full_name;
    }

    if (!avatarUrl && user.user_metadata?.avatar_url) {
      avatarUrl = user.user_metadata.avatar_url;
    }

    userName.textContent = display || emailPrefix;

    if (avatarUrl) {
      userAvatar.src = avatarUrl;
      userAvatar.style.display = 'inline';
    } else {
      const c = document.createElement('canvas');
      c.width = 64; c.height = 64;
      const cx = c.getContext('2d');
      cx.fillStyle='#ffe6e6';
      cx.fillRect(0,0,64,64);
      cx.fillStyle='#e2725b';
      cx.font='bold 26px Nunito';
      cx.textAlign='center';
      cx.textBaseline='middle';
      cx.fillText(initialsFromName(display || emailPrefix), 32, 34);
      userAvatar.src = c.toDataURL();
      userAvatar.style.borderRadius = '50%';
      userAvatar.style.display = 'inline';
    }

    userMenuRoot.style.display = 'flex';
    return user;
  }

  logoutLink.addEventListener('click', async (e)=>{
     e.preventDefault();
     await sb.auth.signOut();
     location.href = "cadastrarouentrar.html";
  });

  // ========== 2. GRID DE PETS ==========
  function petCardHtml(p){
      const photoContent = p.photo_url 
          ? `<img src="${p.photo_url}" alt="${p.name || 'Pet'}">` 
          : `<i class="fa-solid fa-paw photo-placeholder"></i>`;

      return `
      <div class="card">
          <div class="photo">
              ${photoContent}
          </div>
          <div class="body">
              <h3>${p.name || 'Sem nome'}</h3>
              <p>${p.species || '-'} ‚Ä¢ ${p.breed || 'SRD'}</p>
              <div class="details-row">
                  <span><i class="fa-solid fa-venus-mars"></i> ${p.sex||'--'}</span> ‚Ä¢ 
                  <span><i class="fa-solid fa-ruler-horizontal"></i> ${p.size||'--'}</span>
              </div>
          </div>
          <div class="card-cta">
              <button class="btn-icon" onclick="startEdit('${p.id}')" title="Editar">
                  <i class="fa-solid fa-pen"></i>
              </button>
              <button class="btn-icon btn-delete" onclick="deletePet('${p.id}', '${p.name || 'este pet'}')" title="Excluir">
                  <i class="fa-solid fa-trash"></i>
              </button>
          </div>
      </div>`;
  }

  async function loadPets(user){
    petsWrap.innerHTML = `<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:2rem;color:var(--brand);margin-bottom:10px"></i> Carregando...</div>`;
    const { data, error } = await sb.from('pets')
      .select('id,name,species,breed,sex,size,photo_url')
      .eq('owner_id', user.id)
      .order('created_at', { ascending: false });

    if(error) {
      petsWrap.innerHTML=`<div class="empty">Erro: ${error.message}</div>`;
      return;
    }
    
    if(!data || data.length === 0) { 
        petsWrap.innerHTML=`
        <div class="empty">
            <i class="fa-regular fa-folder-open" style="font-size: 2.5rem; margin-bottom: 15px; opacity: 0.5;"></i>
            Voc√™ ainda n√£o tem pets cadastrados. 
            <a href="cadastroPets.html" style="color:var(--brand); font-weight:700; margin-top: 8px;">Cadastrar agora</a>
        </div>`; 
        return; 
    }

    petsWrap.innerHTML = '<div class="grid"></div>';
    const grid = petsWrap.querySelector('.grid');

    data.forEach(p => {
        grid.insertAdjacentHTML('beforeend', petCardHtml(p));
    });
  }

  // ========== 3. CONFIRM DELETE PET ==========
  const ppConfirm = document.getElementById('ppConfirm');
  const ppMsg = document.getElementById('ppMsg');
  const ppOk = document.getElementById('ppOk');
  const ppCancel = document.getElementById('ppCancel');

  function prettyConfirm(message){
    return new Promise(res=>{
      ppMsg.textContent = message;
      ppConfirm.style.display='flex'; 
      requestAnimationFrame(()=>ppConfirm.querySelector('.pp-card').classList.add('show'));
      const cleanup=v=>{ 
          ppConfirm.querySelector('.pp-card').classList.remove('show'); 
          setTimeout(()=>{ppConfirm.style.display='none';},140); 
          res(v); 
      };
      ppOk.onclick=()=>cleanup(true);
      ppCancel.onclick=()=>cleanup(false);
      ppConfirm.onclick = (e)=>{ if(e.target.id === 'ppConfirm') cleanup(false); };
    });
  }

  window.deletePet = async (id, name) => {
      if(await prettyConfirm(`Excluir ${name}?`)){
          const { error } = await sb.from('pets').delete().eq('id', id);
          if(error) { toast('Erro: ' + error.message); }
          else { 
              toast('Pet removido!');
              const { data:{ user } } = await sb.auth.getUser();
              loadPets(user); 
          }
      }
  }

  // ========== 4. EDITAR PET ==========
  window.startEdit = async (id) => {
      const { data, error } = await sb.from('pets').select('*').eq('id', id).single();
      if(error || !data){
        toast('Erro ao carregar pet para edi√ß√£o.');
        return;
      }

      newUploadedPhotoUrl = null; // reset ao abrir modal

      document.getElementById('edit_id').value = data.id;
      document.getElementById('edit_name').value = data.name || '';
      document.getElementById('edit_species').value = data.species || '';
      document.getElementById('edit_breed').value = data.breed || '';
      document.getElementById('edit_sex').value = data.sex || '';
      document.getElementById('edit_size').value = data.size || '';
      document.getElementById('edit_notes').value = data.special_needs || '';
      editPhotoUrlInput.value = data.photo_url || '';

      if (data.photo_url) {
        editPhotoPreview.src = data.photo_url;
        editPhotoPreview.style.display = 'block';
        editPhotoPlaceholder.style.display = 'none';
      } else {
        editPhotoPreview.src = '';
        editPhotoPreview.style.display = 'none';
        editPhotoPlaceholder.style.display = 'inline-block';
      }

      editPhotoFile.value = ''; // limpa input file

      editModal.classList.add('show');
  };

  function closeEdit(){ 
      const box = editModal.querySelector('.box');
      box.style.transform = 'translateY(20px)';
      editModal.style.opacity = '0';
      setTimeout(() => {
          editModal.classList.remove('show');
          box.style.transform = '';
          editModal.style.opacity = '';
      }, 200);
  }
  document.getElementById('closeEdit').onclick = closeEdit;
  document.getElementById('cancelEdit').onclick = closeEdit;
  editModal.addEventListener('click', (e)=>{ if(e.target.id === 'editModal') closeEdit(); });

  // quando escolher nova foto
  editPhotoFile.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;

    if(!currentUser){
      toast('Erro: usu√°rio n√£o identificado.');
      return;
    }

    // preview instant√¢neo
    editPhotoPreview.src = URL.createObjectURL(file);
    editPhotoPreview.style.display = 'block';
    editPhotoPlaceholder.style.display = 'none';

    const petId = document.getElementById('edit_id').value;

    try{
      toast('Enviando foto...');
      const url = await uploadPetPhoto(file, currentUser.id, petId);
      newUploadedPhotoUrl = url;
      editPhotoUrlInput.value = url; // j√° preenche o campo URL
      toast('Foto atualizada!');
    }catch(err){
      console.error('uploadPetPhoto error:', err);
      toast('Erro ao enviar foto.');
    }
  });

  document.getElementById('saveEdit').onclick = async () => {
      const id = document.getElementById('edit_id').value;
      const finalPhotoUrl = (newUploadedPhotoUrl || editPhotoUrlInput.value.trim()) || null;

      const updates = {
          name: document.getElementById('edit_name').value.trim(),
          species: document.getElementById('edit_species').value.trim(),
          breed: document.getElementById('edit_breed').value.trim() || null,
          sex: document.getElementById('edit_sex').value || null,
          size: document.getElementById('edit_size').value || null,
          special_needs: document.getElementById('edit_notes').value.trim() || null,
          photo_url: finalPhotoUrl
      };
      if(!updates.name || !updates.species){
        toast('Informe pelo menos Nome e Esp√©cie.');
        return;
      }
      const { error } = await sb.from('pets').update(updates).eq('id', id);
      if(error) { toast('Erro ao salvar.'); }
      else {
          toast('Pet atualizado!');
          closeEdit();
          const { data:{ user } } = await sb.auth.getUser();
          loadPets(user);
      }
  };

  // ========== 5. EXCLUIR CONTA ==========
  const ppDelete = document.getElementById('ppDelete');
  const delOk = document.getElementById('delOk');
  const delCancel = document.getElementById('delCancel');
  const delInput = document.getElementById('delConfirmText');

  deleteAccountLink.addEventListener('click', (e)=>{
    e.preventDefault();
    ppDelete.style.display = 'flex';
    requestAnimationFrame(()=>ppDelete.querySelector('.pp-card').classList.add('show'));
  });

  delCancel.addEventListener('click', ()=>{
    ppDelete.querySelector('.pp-card').classList.remove('show');
    setTimeout(()=>ppDelete.style.display='none',140);
  });

  delOk.addEventListener('click', ()=>{
    if(delInput.value === 'EXCLUIR'){
      window.location.href = 'processaExclusao.php';
    } else {
      alert('Por favor, digite EXCLUIR corretamente.');
    }
  });

  // ========== BOOT ==========
  (async function(){
      const user = await initUser();
      if(user) await loadPets(user);
  })();
</script>
</body>
</html>