<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seus Dados - Patas Pousada</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

    :root{
      --brand:#e2725b; --brand-strong:#d45f47; --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --white:#fff;
      --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.06); --line:#e5e7eb;
      --chip:#fff0ec; --chip-border:#ffd8cf;
      --transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Nunito', sans-serif; background-color: var(--bg); color: var(--ink); -webkit-font-smoothing: antialiased; line-height: 1.5; }
    a { text-decoration: none; color: inherit; }

    /* HEADER - AUMENTADO PADDING */
    header{display:flex;justify-content:center;background:rgba(255,255,255,0.95);box-shadow:0 1px 3px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px);}
    nav{max-width:1100px;width:100%;padding:16px 24px;display:flex;align-items:center;justify-content: space-between;}
    
    /* LOGO MAIOR */
    .logo{display:flex;align-items:center;gap:10px; color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800; font-size: 1.35rem;}
    .logo img{width:34px;height:34px;}
    
    /* LINKS MAIORES */
    nav ul{list-style:none;display:flex;gap:24px;margin:0;padding:0; align-items: center;}
    nav ul a{font-family:Parkinsans,sans-serif;font-weight:600;color:#4b5563; font-size: 1rem; transition: color var(--transition);}
    nav ul a:hover{color:var(--brand)}

    /* USER MENU - AJUSTADO TAMANHO */
    .user-menu{position:relative; display:flex; align-items:center;}
    
    .user-menu-trigger{display:flex;align-items:center;gap:10px;cursor:pointer; padding: 6px 12px 6px 6px; border-radius: 40px; transition: background var(--transition); border: 1px solid transparent;}
    .user-menu-trigger:hover { background: #fff; border-color: var(--line); box-shadow: var(--shadow); }
    
    /* AVATAR MAIOR (40px) */
    .user-menu-trigger img { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #fff; object-fit: cover; background: #eee; }
    
    /* NOME MAIOR */
    .user-menu-trigger span { font-weight: 700; font-size: 1rem; color: var(--ink); max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-menu-trigger svg { width: 12px; fill: #9ca3af; transition: transform .2s; }
    .user-menu:hover .user-menu-trigger svg{ transform: rotate(180deg); }

    .user-dropdown{ display:none; position:absolute; top:calc(100% + 8px); right:0; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.1); width:220px; z-index:100; padding:6px; opacity:0; visibility:hidden; transform:translateY(10px); transition:.2s; }
    .user-menu:hover .user-dropdown{ display:block; opacity:1; visibility:visible; transform:translateY(0); }
    .user-dropdown li { list-style: none; }
    .user-dropdown li a{ display:flex; align-items:center; gap:10px; padding:10px 14px; font-size:0.85rem; color:#4b5563; font-weight: 600; border-radius: 8px; transition: background 0.2s; }
    .user-dropdown li a:hover{ background:#f9fafb; color: var(--brand); }
    .user-dropdown .icon{ width:16px; height:16px; fill: currentColor; }

    /* CONTAINER PRINCIPAL */
    .container { max-width: 800px; margin: 32px auto; padding: 0 20px; }

    /* BOTÃO VOLTAR */
    .btn-back {
        display: inline-flex; align-items: center; gap: 8px;
        background: #fff; border: 1px solid var(--line);
        padding: 8px 16px; border-radius: 30px;
        color: var(--muted); font-weight: 700; font-size: 0.9rem;
        text-decoration: none; transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03); margin-bottom: 24px;
    }
    .btn-back:hover { border-color: var(--brand); color: var(--brand); background: #fff; transform: translateX(-2px); }

    /* TABS DE NAVEGAÇÃO */
    .submenu { 
        display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 24px; 
        scrollbar-width: none; /* Firefox */
    }
    .submenu::-webkit-scrollbar { display: none; } /* Chrome/Safari */

    .submenu a { 
        padding: 10px 16px; text-decoration: none; font-family: 'Parkinsans', sans-serif; 
        font-size: 0.9rem; font-weight: 600; color: #6b7280; 
        border: 1px solid transparent; border-radius: 20px; background: #fff;
        transition: all 0.2s ease; white-space: nowrap; display: flex; align-items: center; gap: 8px;
    }
    .submenu a:hover { background: #fff; border-color: #d1d5db; color: var(--ink); }
    .submenu a.active { background: var(--brand); color: #fff; border-color: var(--brand); box-shadow: 0 4px 10px rgba(226, 114, 91, 0.3); }
    .submenu a i { font-size: 0.85rem; }

    /* CARDS DE CONTEÚDO (ABAS) */
    .aba { display: none; background: #fff; border-radius: 16px; padding: 32px; box-shadow: var(--shadow); animation: fadeIn 0.3s ease; }
    .aba.ativa { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    h2 { font-size: 1.6rem; color: var(--ink); margin-bottom: 6px; font-family: 'Parkinsans', sans-serif; font-weight: 800; }
    .sub { color: var(--muted); margin-bottom: 30px; font-size: 0.95rem; }

    /* FOTO DE PERFIL */
    .foto-perfil { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px solid var(--line); text-align: center; }
    .foto-wrapper { position: relative; width: 100px; height: 100px; cursor: pointer; }
    .foto-wrapper img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.3s; }
    .foto-wrapper:hover img { opacity: 0.9; }
    .foto-badge {
        position: absolute; bottom: 0; right: 0; background: var(--brand); color: #fff;
        width: 32px; height: 32px; border-radius: 50%; display: grid; place-items: center;
        border: 3px solid #fff; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .foto-perfil span { font-size: 0.85rem; color: var(--muted); max-width: 300px; line-height: 1.4; }

    /* FORMULÁRIOS */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 20px; width: 100%; }
    
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; gap: 0; } }

    .label-above { font-size: 0.9rem; color: #374151; font-weight: 700; }
    
    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
        width: 100%; padding: 12px 16px; font-size: 0.95rem; border: 1px solid #d1d5db; 
        border-radius: 10px; background-color: #fff; outline: none; font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px var(--chip); }
    input[readonly] { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }

    button[type="submit"] { 
        background-color: var(--brand); color: white; padding: 14px 30px; border: none; 
        font-size: 1rem; font-weight: 700; border-radius: 30px; cursor: pointer; 
        transition: all 0.2s; display: block; width: 100%; font-family: 'Parkinsans', sans-serif;
        box-shadow: 0 4px 12px rgba(226, 114, 91, 0.3);
    }
    button[type="submit"]:hover { background-color: var(--brand-strong); transform: translateY(-2px); }

    .hint { font-size: 0.9rem; margin-top: 15px; text-align: center; font-weight: 600; min-height: 20px; }
    .ok { color: #059669; } 
    .err { color: #dc2626; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <header>
    <nav>
      <a href="index.html" class="logo">
        <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="Ícone">
        <p>Patas Pousada</p>
      </a>
      <ul>
        <li><a href="reservas.html">Reservas</a></li>
        <li><a href="ajuda.html">Ajuda</a></li>
        <li><a href="Lartemp.html" style="color: #d74f4f;">Lar Temporário</a></li>
        <li class="user-menu">
            <div class="user-menu-trigger">
                <img id="avatarTop" src="https://images.icon-icons.com/1146/PNG/512/1486485564-add-character-include-more-person-user_81147.png" alt="Foto">
                <span id="userTop">Usuário</span>
                <svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5H7z"></path></svg>
            </div>
            <ul class="user-dropdown">
                <li><a href="menu_perfil.html"><svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg> Editar perfil </a></li>
                <li><a href="meusPets.html"><svg class="icon" viewBox="0 0 24 24"><path d="M12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm4.83-1.17c.38-.38.38-.99 0-1.37l-2.08-2.08c-.38-.38-.99-.38-1.37 0l-2.08 2.08c-.38.38-.38.99 0 1.37l2.08 2.08c.37.39.98.39 1.37 0l2.08-2.08zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"></path></svg> Meus pets </a></li>
                <li><a href="#" id="logout"><svg class="icon" viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"></path></svg> Sair </a></li>
            </ul>
        </li>
      </ul>
    </nav>
  </header>

  <div class="container">
    
    <a href="menu_perfil.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i> Voltar para o menu</a>

    <div class="submenu">
      <a href="#" class="active" onclick="mostrarAba(event, 'aba-dados')"><i class="fa-regular fa-id-card"></i> Seus dados</a>
      <a href="#" onclick="mostrarAba(event, 'aba-endereco')"><i class="fa-solid fa-map-location-dot"></i> Endereço</a>
      <a href="#" onclick="mostrarAba(event, 'aba-documentos')"><i class="fa-solid fa-passport"></i> Documentos</a>
      <a href="#" onclick="mostrarAba(event, 'aba-telefone')"><i class="fa-solid fa-phone"></i> Telefone</a>
      <a href="#" onclick="mostrarAba(event, 'aba-contatos')"><i class="fa-solid fa-truck-medical"></i> Emergência</a>
    </div>

    <div class="aba ativa" id="aba-dados">
      <h2>Seus dados</h2>
      <p class="sub">Gostaríamos de saber um pouco sobre você.</p>

      <div class="foto-perfil">
        <label for="fotoInput" class="foto-wrapper">
          <img id="preview" src="https://images.icon-icons.com/1146/PNG/512/1486485564-add-character-include-more-person-user_81147.png" alt="Foto de perfil">
          <div class="foto-badge"><i class="fa-solid fa-camera"></i></div>
        </label>
        <input type="file" id="fotoInput" accept="image/*" style="display:none">
        <span>Toque na foto para alterar.<br>Escolha uma imagem bem iluminada.</span>
      </div>

      <form id="form-dados">
        <div class="form-row">
          <div class="form-group">
              <label class="label-above">Nome</label>
              <input type="text" name="first_name" placeholder="Seu primeiro nome">
          </div>
          <div class="form-group">
              <label class="label-above">Sobrenome</label>
              <input type="text" name="last_name" placeholder="Seu sobrenome">
          </div>
        </div>
        <div class="form-group">
          <label class="label-above">E-mail</label>
          <input type="email" name="email" placeholder="E-mail" readonly>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="label-above">Data de Nascimento</label>
                <input type="date" name="birthdate">
            </div>
            <div class="form-group">
                <label class="label-above">Gênero</label>
                <select name="gender">
                    <option selected disabled value="">Selecione</option>
                    <option value="Feminino">Feminino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Outro">Outro</option>
                    <option value="Prefiro Nao Dizer">Prefiro não dizer</option>
                </select>
            </div>
        </div>
        <button type="submit">Salvar alterações</button>
        <div id="hint-dados" class="hint"></div>
      </form>
    </div>

    <div class="aba" id="aba-endereco">
      <h2>Endereço</h2>
      <p class="sub">Informe seu endereço completo abaixo para facilitar buscas.</p>
      <form id="form-endereco">
        <div class="form-row">
            <div class="form-group" style="flex: 3;">
                <label class="label-above">Rua / Avenida</label>
                <input type="text" name="address_street" placeholder="Rua das Flores" />
            </div>
            <div class="form-group" style="flex: 1;">
                <label class="label-above">Número</label>
                <input type="text" name="address_number" placeholder="123" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="label-above">Bairro</label>
                <input type="text" name="address_district" placeholder="Bairro" />
            </div>
            <div class="form-group">
                <label class="label-above">Cidade</label>
                <input type="text" name="address_city" placeholder="Cidade" />
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="label-above">Estado</label>
                <input type="text" name="address_state" placeholder="Estado (UF)" />
            </div>
            <div class="form-group">
                <label class="label-above">CEP</label>
                <input type="text" name="address_zip" placeholder="00000-000" />
            </div>
        </div>
        <button type="submit">Salvar endereço</button>
        <div id="hint-end" class="hint"></div>
      </form>
    </div>

    <div class="aba" id="aba-documentos">
      <h2>Seus Documentos</h2>
      <p class="sub">Usados apenas para validação de identidade na plataforma.</p>
      <form id="form-docs">
        <div class="form-group">
          <label class="label-above">CPF</label>
          <input type="text" name="cpf" placeholder="XXX.XXX.XXX-XX" maxlength="14" />
        </div>
        <div class="form-group">
          <label class="label-above">RG</label>
          <input type="text" name="rg" placeholder="Somente números" maxlength="20" />
        </div>
        <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--line);">
        <button type="submit">Salvar documentos</button>
        <div id="hint-docs" class="hint"></div>
      </form>
    </div>

    <div class="aba" id="aba-telefone">
      <h2>Contato</h2>
      <p class="sub">Mantenha seu número atualizado para receber notificações.</p>
      <form id="form-phone">
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label class="label-above">País</label>
            <input type="text" name="phone_country" value="+55" readonly>
          </div>
          <div class="form-group" style="flex:3;">
            <label class="label-above">Celular com DDD</label>
            <input type="tel" name="phone_number" placeholder="(XX) 9XXXX-XXXX">
          </div>
        </div>
        <button type="submit">Salvar telefone</button>
        <div id="hint-phone" class="hint"></div>
      </form>
    </div>

    <div class="aba" id="aba-contatos">
      <h2>Emergência</h2>
      <p class="sub">Quem devemos acionar caso não consigamos falar com você?</p>
      <form id="form-emergency">
        <div class="form-row">
          <div class="form-group">
            <label class="label-above">Nome do contato</label>
            <input type="text" name="emergency_first_name" placeholder="Nome">
          </div>
          <div class="form-group">
            <label class="label-above">Sobrenome</label>
            <input type="text" name="emergency_last_name" placeholder="Sobrenome">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label class="label-above">País</label>
            <input type="text" name="emergency_phone_country" value="+55" readonly>
          </div>
          <div class="form-group" style="flex:3;">
            <label class="label-above">Celular de emergência</label>
            <input type="tel" name="emergency_phone_number" placeholder="(XX) XXXXX-XXXX">
          </div>
        </div>
        <button type="submit">Salvar contato de emergência</button>
        <div id="hint-emg" class="hint"></div>
      </form>
    </div>
  </div>

  <script>
    // ========= CONFIG SUPABASE =========
    const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= HELPERS =========
    function mostrarAba(event, idAba) {
      event.preventDefault();
      document.querySelectorAll('.aba').forEach(div => div.classList.remove('ativa'));
      const abaSelecionada = document.getElementById(idAba);
      if (abaSelecionada) abaSelecionada.classList.add('ativa');
      document.querySelectorAll('.submenu a').forEach(link => link.classList.remove('active'));
      event.currentTarget.classList.add('active');
    }

    function toast(el, ok, msg){
      el.className = 'hint ' + (ok ? 'ok' : 'err');
      el.innerHTML = (ok ? '<i class="fa-solid fa-check-circle"></i> ' : '<i class="fa-solid fa-circle-exclamation"></i> ') + msg;
      setTimeout(()=>{ el.textContent=''; }, 3000);
    }

    // ======== UPLOAD DE AVATAR (BUCKET tutor-avatars) =========
    async function uploadAvatar(file, userId){
      const ext = file.name.split('.').pop();
      const path = `${userId}/avatar.${ext}`;
      const { error } = await sb
        .storage
        .from('tutor-avatars')
        .upload(path, file, { upsert:true, contentType:file.type });
      if(error) throw error;

      const { data:pub } = sb.storage.from('tutor-avatars').getPublicUrl(path);
      return pub.publicUrl;
    }

    // ========= AUTH + LOAD =========
    let currentUser = null;
    let profile = {};

    async function requireAuth(){
      const { data:{ user } } = await sb.auth.getUser();
      if(!user){
        location.href = "cadastrarouentrar.html?next=menu_perfil.html";
        return null;
      }
      return user;
    }

    function resolveDisplayName(user, prof){
      const emailPrefix = user.email.split('@')[0];
      let display = emailPrefix;

      if (prof) {
        if (prof.first_name || prof.last_name) {
          const composed = `${prof.first_name || ''} ${prof.last_name || ''}`.trim();
          if (composed) display = composed;
        } else if (prof.full_name && prof.full_name.trim() !== '') {
          display = prof.full_name;
        }
      }

      if ((display === emailPrefix || !display) && user.user_metadata?.full_name) {
        display = user.user_metadata.full_name;
      }

      return display || emailPrefix;
    }

    function fillTopBar(name, avatarUrl){
      document.getElementById('userTop').textContent = name || 'Usuário';
      if (avatarUrl) {
        // AQUI ESTÁ O FIX: Adiciona o timestamp para forçar o navegador a recarregar a imagem do topo
        const urlComCache = avatarUrl + '?t=' + new Date().getTime();
        document.getElementById('avatarTop').src = urlComCache;
      }
    }

    function fillDados(p, user){
      const f = document.querySelector('#form-dados');
      f.first_name.value = p.first_name || '';
      f.last_name.value  = p.last_name  || '';
      f.email.value      = user.email   || '';
      f.birthdate.value  = p.birthdate  || '';
      f.gender.value     = p.gender     || '';
      if (p.avatar_url){
        // Mesma coisa para o preview principal da página
        const urlComCache = p.avatar_url + '?t=' + new Date().getTime();
        document.getElementById('preview').src = urlComCache;
      }
    }

    function fillEndereco(p){
      const f = document.querySelector('#form-endereco');
      f.address_street.value   = p.address_street   || '';
      f.address_number.value   = p.address_number   || '';
      f.address_district.value = p.address_district || '';
      f.address_city.value     = p.address_city     || '';
      f.address_state.value    = p.address_state    || '';
      f.address_zip.value      = p.address_zip      || '';
    }

    function fillDocs(p){
      const f = document.querySelector('#form-docs');
      f.cpf.value = p.cpf || '';
      f.rg.value  = p.rg  || '';
    }

    function fillPhone(p){
      const f = document.querySelector('#form-phone');
      f.phone_country.value = p.phone_country || '+55';
      f.phone_number.value  = p.phone_number  || '';
    }

    function fillEmergency(p){
      const f = document.querySelector('#form-emergency');
      f.emergency_first_name.value     = p.emergency_first_name     || '';
      f.emergency_last_name.value      = p.emergency_last_name      || '';
      f.emergency_phone_country.value= p.emergency_phone_country|| '+55';
      f.emergency_phone_number.value = p.emergency_phone_number || '';
    }

    async function loadProfile(user){
      const { data, error } = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
      if(error){ console.error('loadProfile error:', error); }
      profile = data || {};

      const display = resolveDisplayName(user, profile);

      fillTopBar(display, profile.avatar_url);
      fillDados(profile, user);
      fillEndereco(profile);
      fillDocs(profile);
      fillPhone(profile);
      fillEmergency(profile);
    }

    // ========= SAVE HANDLERS (UPSERT) =========
    async function save(partial, hintEl){
      const payload = { id: currentUser.id, ...partial, updated_at: new Date().toISOString() };
      const { error } = await sb.from('profiles').upsert(payload, { onConflict: 'id' });
      if(error){
        console.error('Erro Supabase ao salvar:', error);
        toast(hintEl,false,'Erro ao salvar.');
        return false;
      }
      toast(hintEl,true,'Salvo com sucesso!');
      return true;
    }

    // ========= BOOT =========
    (async function init(){
      currentUser = await requireAuth();
      if(!currentUser) return;

      let avatarFile = null;

      document.getElementById('logout').addEventListener('click', async (e)=>{
        e.preventDefault();
        try{ await sb.auth.signOut(); }catch{}
        location.href="cadastrarouentrar.html";
      });

      await loadProfile(currentUser);

      // foto/avatar - Apenas preview
      const fotoInput = document.getElementById('fotoInput');
      fotoInput.addEventListener('change', (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        
        avatarFile = file; 
        document.getElementById('preview').src = URL.createObjectURL(file);
      });

      // form dados - Upload acontece aqui
      document.getElementById('form-dados').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.currentTarget;
        const hint = document.getElementById('hint-dados');

        let currentAvatarUrl = profile.avatar_url;

        // Se houver uma nova foto
        if(avatarFile) {
          try {
            hint.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';
            
            currentAvatarUrl = await uploadAvatar(avatarFile, currentUser.id);
            
            // === AQUI TAMBÉM: Cache Buster para atualização imediata ===
            const cacheBuster = '?t=' + new Date().getTime();
            const urlComCache = currentAvatarUrl + cacheBuster;

            document.getElementById('avatarTop').src = urlComCache;
            document.getElementById('preview').src = urlComCache;
            
            profile.avatar_url = currentAvatarUrl; // Salva URL limpa no objeto
          } catch(err) {
            console.error('uploadAvatar error:', err);
            toast(hint, false, 'Falha ao enviar foto.');
            return;
          }
        }

        // Salva no banco (URL limpa sem o ?t=...)
        const ok = await save({
          first_name: f.first_name.value.trim(),
          last_name : f.last_name.value.trim(),
          birthdate : f.birthdate.value || null,
          gender    : f.gender.value || null,
          avatar_url: currentAvatarUrl
        }, hint);

        if(ok){
          profile.first_name = f.first_name.value.trim();
          profile.last_name  = f.last_name.value.trim();
          profile.birthdate  = f.birthdate.value || null;
          profile.gender     = f.gender.value || null;
          
          avatarFile = null;

          const display = resolveDisplayName(currentUser, profile);
          // Se não houve upload de foto agora, usa a que já tinha (com cache buster se carregar de novo)
          // Se houve upload, o bloco 'if(avatarFile)' acima já atualizou o DOM.
          if(!avatarFile) {
             fillTopBar(display, profile.avatar_url);
          } else {
             // Apenas atualiza o nome se mudou
             document.getElementById('userTop').textContent = display;
          }
        }
      });

      document.getElementById('form-endereco').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.currentTarget;
        await save({
          address_street  : f.address_street.value.trim(),
          address_number  : f.address_number.value.trim(),
          address_district: f.address_district.value.trim(),
          address_city    : f.address_city.value.trim(),
          address_state   : f.address_state.value.trim(),
          address_zip     : f.address_zip.value.trim()
        }, document.getElementById('hint-end'));
      });

      document.getElementById('form-docs').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.currentTarget;
        await save({
          cpf: f.cpf.value.trim(),
          rg : f.rg.value.trim()
        }, document.getElementById('hint-docs'));
      });

      document.getElementById('form-phone').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.currentTarget;
        await save({
          phone_country: f.phone_country.value.trim(),
          phone_number : f.phone_number.value.trim()
        }, document.getElementById('hint-phone'));
      });

      document.getElementById('form-emergency').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.currentTarget;
        await save({
          emergency_first_name    : f.emergency_first_name.value.trim(),
          emergency_last_name     : f.emergency_last_name.value.trim(),
          emergency_phone_country: f.emergency_phone_country.value.trim(),
          emergency_phone_number : f.emergency_phone_number.value.trim()
        }, document.getElementById('hint-emg'));
      });
    })();
  </script>
</body>
</html>