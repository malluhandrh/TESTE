<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alterar Senha — Patas Pousada (Host)</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Parkinsans:wght@300..800&display=swap');

    :root{
      --brand:#e2725b; --brand-strong:#d45f47; --ink:#1f2937; --muted:#6b7280; --bg:#f3f4f6; --white:#fff;
      --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.06); --line:#e5e7eb;
      --chip:#fff0ec; --chip-border:#ffd8cf;
      --danger: #dc2626; --success: #059669;
      --transition: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    *{box-sizing:border-box}
    body{font-family:'Nunito',Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0; -webkit-font-smoothing: antialiased; line-height: 1.5;}
    a { text-decoration: none; color: inherit; }

    /* Header Principal (Barra de Navegação) */
    body > header {
      display:flex;justify-content:center;background:rgba(255,255,255,0.95);
      box-shadow:0 1px 3px rgba(0,0,0,.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px);
    }
    nav{max-width:1100px;width:100%;padding:12px 24px;display:flex;align-items:center;justify-content: space_between;}
    nav{max-width:1100px;width:100%;padding:12px 24px;display:flex;align-items:center;justify-content: space-between;}
    .logo{display:flex;align-items:center;gap:8px; color:var(--brand);font-family:Parkinsans,sans-serif;font-weight:800; font-size: 1.2rem;}
    .logo img{width:28px;height:28px;}
    nav ul{list-style:none;display:flex;gap:20px;margin:0;padding:0; align-items: center;}
    nav ul a{font-family:Parkinsans,sans-serif;font-weight:600;color:#4b5563; font-size: 0.9rem; transition: color var(--transition);}
    nav ul a:hover{color:var(--brand)}

    /* Layout */
    .wrap{max-width:520px;margin:32px auto;padding:0 20px; min-height: 70vh;}
    
    /* Botão Voltar (Topo) */
    .btn-back {
        display: inline-flex; align-items: center; gap: 8px;
        background: #fff; border: 1px solid var(--line);
        padding: 8px 16px; border-radius: 30px;
        color: var(--muted); font-weight: 700; font-size: 0.9rem;
        text-decoration: none; transition: all 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03); margin-bottom: 20px;
    }
    .btn-back:hover { border-color: var(--brand); color: var(--brand); background: #fff; transform: translateX(-2px); }

    /* Cartão Principal */
    .card{
      background:#fff; border-radius:20px;
      box-shadow:var(--shadow); overflow:hidden;
      padding: 32px;
    }

    /* Header do Cartão */
    .card-header {
      text-align: center;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--line);
      padding-bottom: 20px;
    }
    .card-header h1 {
      margin:0 0 4px 0; 
      color:var(--ink); 
      font-family:'Parkinsans',sans-serif; 
      font-size:1.6rem; 
      font-weight: 800;
      display: block;
    }
    .card-header h1 i { margin-right: 8px; vertical-align: middle; }
    .card-header .subtitle { 
      display: block; 
      color: var(--muted); 
      font-size: 0.95rem; 
    }

    /* Form Elements */
    label{display:block;font-size:.9rem; margin:16px 0 6px; color:var(--ink); font-weight: 700;}
    
    .field{position:relative;}
    .field input{
      width:100%; padding:12px 44px 12px 16px; border:1px solid #d1d5db; border-radius:10px;
      background:#fff; color:var(--ink); outline:none; transition:all .2s; font-family: inherit; font-size: 0.95rem;
    }
    .field input:focus{border-color:var(--brand); box-shadow: 0 0 0 3px var(--chip);}
    
    .toggle-eye{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      border:none; background:transparent; cursor:pointer; font-size:1rem; color: var(--muted); transition: color 0.2s;
    }
    .toggle-eye:hover{color: var(--brand);}

    .help{font-size:.85rem; margin-top:6px; text-align: right;}
    
    /* Password Strength Bar */
    .strength{
      margin-top:10px; background:#f3f4f6; height:6px; border-radius:999px; overflow:hidden;
    }
    .strength > span{display:block;height:100%;width:0%;background:var(--danger);transition:width .3s ease, background .3s ease;}

    /* Requirements List */
    .reqs{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:16px; background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid var(--line);}
    .reqs span{font-size:.8rem; display: flex; align-items: center; gap: 6px; font-weight: 600;}
    .reqs .ok{color:var(--success);}
    .reqs .ok::before { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; }
    .reqs .nok{color:var(--muted); opacity: 0.7;}
    .reqs .nok::before { content: '\f111'; font-family: "Font Awesome 6 Free"; font-size: 0.4rem; margin: 0 3px; }

    /* Buttons */
    .actions{display:flex; gap:12px; margin-top:24px;}
    .btn{
      border-radius:30px; padding:12px 20px; font-weight:700; font-family: 'Parkinsans', sans-serif;
      border:2px solid transparent; cursor:pointer; font-size: 0.95rem; transition: all 0.2s; flex: 1;
    }
    .btn-primary{background:var(--brand); color:#fff; border-color:var(--brand); box-shadow: 0 4px 10px rgba(226, 114, 91, 0.3);}
    .btn-primary:hover { background: var(--brand-strong); transform: translateY(-1px); }
    .btn-primary:disabled{opacity:.6; cursor:not-allowed; transform: none; box-shadow: none;}
    
    .btn-link{background:transparent; border:none; color:var(--brand); cursor:pointer; font-weight: 700; font-size: 0.85rem;}
    .btn-link:hover { text-decoration: underline; }

    .msg{margin-top:16px; font-size:.9rem; min-height:1.2em; text-align: center; font-weight: 600;}
    .msg.ok{color:var(--success)}
    .msg.err{color:var(--danger)}

    footer{text-align:center; color:var(--muted); margin-top:40px; font-size:.85rem; padding-bottom: 20px;}

    /* Toast */
    .toast{
      position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
      background:#1f2937; color:#fff; padding:12px 24px; border-radius:30px;
      box-shadow:0 10px 30px rgba(0,0,0,.2); font-size:.9rem; display:none; z-index:200; font-weight: 600;
      align-items: center; gap: 10px;
    }
    .toast.show{display:flex;}
    .toast.success { background: var(--success); }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="home_host.html" class="logo">
        <img src="https://images.vexels.com/media/users/3/202255/isolated/preview/a095b3fe28f3c9febbf176089e2d7e08-pegada-de-cachorro-com-osso-de-coracao-rosa-plana.png" alt="">
        Patas Pousada
      </a>
      <ul>
        <li><a href="home_host.html">Painel</a></li>
        <li><a href="ajuda.html">Ajuda</a></li>
      </ul>
    </nav>
  </header>

  <div class="wrap">
    <button id="btn-voltar" class="btn-back">
      <i class="fa-solid fa-arrow-left"></i> Voltar para o menu
    </button>

    <div class="card">
      <div class="card-header">
        <h1><i class="fa-solid fa-shield-halved" style="color: var(--brand);"></i> Segurança</h1>
        <span class="subtitle">Gerencie a senha de acesso da sua conta de anfitrião</span>
      </div>
      
      <form id="formSenha">
        <div id="bloco-senha-atual">
          <label for="senha-atual">Senha atual</label>
          <div class="field">
            <input type="password" id="senha-atual" autocomplete="current-password" placeholder="Digite sua senha atual" required>
            <button class="toggle-eye" type="button" data-target="senha-atual"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="help">
            <button id="btn-esqueci" type="button" class="btn-link">Esqueceu sua senha?</button>
          </div>
        </div>

        <label for="nova-senha">Nova senha</label>
        <div class="field">
          <input type="password" id="nova-senha" autocomplete="new-password" placeholder="Crie uma nova senha forte" required>
          <button class="toggle-eye" type="button" data-target="nova-senha"><i class="fa-regular fa-eye"></i></button>
        </div>
        <div class="strength"><span id="bar"></span></div>

        <label for="confirmar-senha">Confirmar nova senha</label>
        <div class="field">
          <input type="password" id="confirmar-senha" autocomplete="new-password" placeholder="Repita a nova senha" required>
          <button class="toggle-eye" type="button" data-target="confirmar-senha"><i class="fa-regular fa-eye"></i></button>
        </div>

        <div class="reqs" id="reqs">
          <span id="r-len" class="nok">Mínimo de 8 caracteres</span>
          <span id="r-case" class="nok">Maiúscula e minúscula</span>
          <span id="r-num" class="nok">Pelo menos 1 número</span>
          <span id="r-spec" class="nok">Pelo menos 1 símbolo</span>
        </div>

        <div class="msg" id="msg"></div>

        <div class="actions">
          <button class="btn btn-primary" id="btn-salvar" type="submit" disabled>Salvar Alterações</button>
        </div>
      </form>
    </div>
    
    <footer>&copy; 2025 Patas Pousada. Todos os direitos reservados.</footer>
  </div>

  <div class="toast" id="toast">
    <i class="icon fa-solid fa-circle-info"></i>
    <span id="toastMsg">Mensagem do sistema</span>
    <button id="toastClose" style="background:none; border:none; color:#fff; cursor:pointer; margin-left:10px;">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://nwbgzokttjgkipwzfgzc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_wn2dxmpI7gFOx4nLh5oHqg_Qlc4Q0lQ";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const f = document.getElementById('formSenha');
    const btnSalvar = document.getElementById('btn-salvar');
    const btnVoltar = document.getElementById('btn-voltar');
    const msg = document.getElementById('msg');
    const blocoSenhaAtual = document.getElementById('bloco-senha-atual');
    const inputSenhaAtual = document.getElementById('senha-atual');

    let isRecovery = false; 
    let currentUser = null;

    // ===== TOAST =====
    function toast(message, title="Aviso", type="alert"){
      const t=document.getElementById('toast');
      const msgEl=document.getElementById('toastMsg');
      const icon=t.querySelector('.icon');
      
      t.className = 'toast ' + (type === 'success' ? 'success' : '');
      msgEl.textContent = message;
      icon.className = type === 'success' ? 'icon fa-solid fa-circle-check' : 'icon fa-solid fa-envelope';
      
      t.classList.add('show');
      document.getElementById('toastClose').onclick = () => t.classList.remove('show');
      setTimeout(() => t.classList.remove('show'), 5000);
    }

    // Mostrar/ocultar senha
    document.querySelectorAll('.toggle-eye').forEach(b=>{
      b.addEventListener('click', ()=>{
        const input = document.getElementById(b.dataset.target);
        const icon = b.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
      });
    });

    // Validação e força
    const inputNova = document.getElementById('nova-senha');
    const inputConf = document.getElementById('confirmar-senha');
    const bar = document.getElementById('bar');

    function checkReqs(s){
      const r = {
        len: s.length >= 8,
        case: /[a-z]/.test(s) && /[A-Z]/.test(s),
        num: /\d/.test(s),
        spec: /[^A-Za-z0-9]/.test(s)
      };
      document.getElementById('r-len' ).className = r.len  ? 'ok' : 'nok';
      document.getElementById('r-case').className = r.case ? 'ok' : 'nok';
      document.getElementById('r-num' ).className = r.num  ? 'ok' : 'nok';
      document.getElementById('r-spec').className = r.spec ? 'ok' : 'nok';

      const score = Object.values(r).filter(Boolean).length;
      bar.style.width = (score*25)+'%';
      bar.style.background = score<=1 ? '#ef4444' : score===2 ? '#f59e0b' : score===3 ? '#22c55e' : '#059669';
      return r;
    }

    function updateButton(){
      const s1 = inputNova.value, s2 = inputConf.value;
      const ok = Object.values(checkReqs(s1)).every(Boolean) && s1 === s2;
      btnSalvar.disabled = !ok;
      msg.className = 'msg ' + (s1 && s2 ? (s1===s2 ? 'ok' : 'err') : '');
      msg.innerHTML = s1 && s2
        ? (s1===s2 ? '<i class="fa-solid fa-check"></i> Senhas conferem.'
                   : '<i class="fa-solid fa-xmark"></i> As senhas não coincidem.')
        : '';
    }
    inputNova.addEventListener('input', updateButton);
    inputConf.addEventListener('input', updateButton);

    // Esqueci a senha (host logado pedindo link)
    document.getElementById('btn-esqueci').addEventListener('click', async ()=>{
      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        window.location.href = "cadastrarouentrar.html?next=alterar_senha_host.html";
        return;
      }
      try{
        const redirectTo = window.location.origin + '/alterar_senha_host.html';
        const { error } = await sb.auth.resetPasswordForEmail(user.email, { redirectTo });
        if(error) throw error;
        toast('Enviamos um link de redefinição para o seu e-mail.', 'Verifique seu e-mail!', 'alert');
      }catch(err){
        toast('Erro: '+err.message, 'Falha no envio', 'alert');
      }
    });

    // Envio do formulário
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';
      msg.textContent = '';

      const atual = inputSenhaAtual.value;
      const nova  = inputNova.value;

      try{
        const { data: { user } } = await sb.auth.getUser();
        if(!user){
          window.location.href = "cadastrarouentrar.html?next=alterar_senha_host.html";
          return;
        }

        // fluxo normal (não recovery): exige senha atual
        if(!isRecovery){
          const { error: reauthErr } = await sb.auth.signInWithPassword({
            email: user.email,
            password: atual
          });
          if(reauthErr){ throw new Error('Senha atual incorreta.'); }
        }

        const { error: updErr } = await sb.auth.updateUser({ password: nova });
        if(updErr){ throw updErr; }

        toast(
          isRecovery
            ? 'Sua senha foi redefinida com sucesso! Faça login novamente com a nova senha.'
            : 'Sua senha foi alterada com sucesso!',
          'Sucesso!',
          'success'
        );

        await sb.auth.signOut();
        setTimeout(()=>{
          window.location.href = "cadastrarouentrar.html?next=home_host.html";
        }, 1800);

      }catch(err){
        msg.className = 'msg err';
        msg.textContent = err.message || 'Falha ao alterar a senha.';
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'Salvar Alterações';
      }
    });

    // Botão VOLTAR (sempre para o menu de perfil do host)
    btnVoltar.addEventListener('click', ()=>{
      window.location.href = "menu_perfil_host.html";
    });

    // Guard + fluxo recovery
    (async function guard(){
      const url = new URL(window.location.href);
      isRecovery = url.searchParams.get('type') === 'recovery';

      const { data: { user } } = await sb.auth.getUser();

      if(!user){
        currentUser = null;

        if(isRecovery){
          blocoSenhaAtual.style.display = 'none';
          inputSenhaAtual.required = false;
          msg.className = 'msg err';
          msg.textContent = 'Este link de redefinição é inválido ou já foi utilizado. Peça outro na tela de login.';
          btnSalvar.disabled = true;
          return;
        }else{
          window.location.href = "cadastrarouentrar.html?next=alterar_senha_host.html";
          return;
        }
      }

      currentUser = user;

      if(isRecovery){
        // vindo do e-mail: não exige senha atual
        blocoSenhaAtual.style.display = 'none';
        inputSenhaAtual.required = false;
      }
    })();
  </script>
</body>
</html>
